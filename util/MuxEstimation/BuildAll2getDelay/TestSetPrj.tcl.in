# to run:
# quartus_sh -t setup_proj.tcl <family> <verilog_name>

# Load necessary package.
load_package flow
load_package report
#load_package ::quartus::sta

project_new @TEST_NAMES@ -overwrite

#set_global_assignment -name FAMILY [lindex $quartus(args) 0]
#set_global_assignment -name DEVICE AUTO

# if {"adpcm_main_IMS_ASAP_main_DUT_RTL" == "jpeg2bmp_main_IMS_ASAP_main_DUT_RTL" | "adpcm_main_IMS_ASAP_main_DUT_RTL" == "adpcm_main_IMS_ASAP_main_DUT_RTL"} {
# Target: StratixII
# set_global_assignment -name FAMILY StratixII
# set_global_assignment -name DEVICE EP2S60F484C3
# } else {
# Target: DE2 Board
set_global_assignment -name FAMILY CycloneII
set_global_assignment -name DEVICE EP2C70F896C6
# }

# Build project and specify some confige
# =====================
set_global_assignment -name TOP_LEVEL_ENTITY @TEST_NAMES@
set_global_assignment -name SOURCE_FILE @TEST_VERILOG@
set_global_assignment -name SDC_FILE @SDC_FILE@
# if {"adpcm_main_IMS_ASAP_main_DUT_RTL" == "jpeg2bmp_main_IMS_ASAP_main_DUT_RTL" | "adpcm_main_IMS_ASAP_main_DUT_RTL" == "adpcm_main_IMS_ASAP_main_DUT_RTL"} {

# } else {
# Assign pins
# =====================
# set_location_assignment PIN_G26 -to rstN
# set_location_assignment PIN_N23 -to start
# set_location_assignment PIN_AE22 -to LED7[0]
# set_location_assignment PIN_AF22 -to LED7[1]
# set_location_assignment PIN_W19 -to LED7[2]
# set_location_assignment PIN_V18 -to LED7[3]
# set_location_assignment PIN_U18 -to LED7[4]
# set_location_assignment PIN_U17 -to LED7[5]
# set_location_assignment PIN_AA20 -to LED7[6]
# set_location_assignment PIN_Y18 -to LED7[7]
# set_location_assignment PIN_N2 -to clk
# }
set_global_assignment -name RESERVE_ALL_UNUSED_PINS "AS INPUT TRI-STATED"
set_global_assignment -name RESERVE_ASDO_AFTER_CONFIGURATION "AS OUTPUT DRIVING AN UNSPECIFIED SIGNAL"
set_global_assignment -name STRATIX_DEVICE_IO_STANDARD LVTTL
set_global_assignment -name ERROR_CHECK_FREQUENCY_DIVISOR 1

set_global_assignment -name RESERVE_ALL_UNUSED_PINS_NO_OUTPUT_GND "AS INPUT TRI-STATED"
set_global_assignment -name LL_ROOT_REGION ON -section_id "Root Region"
set_global_assignment -name LL_MEMBER_STATE LOCKED -section_id "Root Region"
# Create timing assignments
#create_base_clock -fmax "100 MHz" -target clk clk

# turn small rams into logic
#set_global_assignment -name AUTO_RAM_TO_LCELL_CONVERSION ON

# prevent DSP blocks from being used
#set_global_assignment -name DSP_BLOCK_BALANCING "LOGIC ELEMENTS"

# minimize circuit area when packing
#set_global_assignment -name INI_VARS "fit_pack_for_density_light=on; fit_report_lab_usage_stats=on"

# extra synthesis options
#set_global_assignment -name SMART_RECOMPILE ON
#set_global_assignment -name OPTIMIZE_MULTI_CORNER_TIMING ON
# if {"OFF" == "ON"} {
  set_global_assignment -name PHYSICAL_SYNTHESIS_COMBO_LOGIC ON
  set_global_assignment -name PHYSICAL_SYNTHESIS_REGISTER_RETIMING ON
  set_global_assignment -name PHYSICAL_SYNTHESIS_REGISTER_DUPLICATION ON
  set_global_assignment -name PHYSICAL_SYNTHESIS_ASYNCHRONOUS_SIGNAL_PIPELINING ON
  set_global_assignment -name PHYSICAL_SYNTHESIS_COMBO_LOGIC_FOR_AREA ON
  set_global_assignment -name PHYSICAL_SYNTHESIS_MAP_LOGIC_TO_MEMORY_FOR_AREA ON
  set_global_assignment -name PHYSICAL_SYNTHESIS_EFFORT EXTRA
# }
#set_global_assignment -name NUM_PARALLEL_PROCESSORS ALL
#set_global_assignment -name FLOW_ENABLE_IO_ASSIGNMENT_ANALYSIS ON
#set_global_assignment -name CYCLONEII_OPTIMIZATION_TECHNIQUE SPEED
#set_global_assignment -name SYNTH_TIMING_DRIVEN_SYNTHESIS ON
#set_global_assignment -name ADV_NETLIST_OPT_SYNTH_WYSIWYG_REMAP ON
#set_global_assignment -name OPTIMIZE_POWER_DURING_FITTING "NORMAL COMPILATION"
#set_global_assignment -name ROUTER_TIMING_OPTIMIZATION_LEVEL MAXIMUM
#set_global_assignment -name PLACEMENT_EFFORT_MULTIPLIER 4
#set_global_assignment -name ROUTER_EFFORT_MULTIPLIER 4
#set_global_assignment -name FINAL_PLACEMENT_OPTIMIZATION ALWAYS
#set_global_assignment -name FITTER_AGGRESSIVE_ROUTABILITY_OPTIMIZATION AUTOMATICALLY
#set_global_assignment -name ENABLE_DRC_SETTINGS ON
#set_global_assignment -name SAVE_DISK_SPACE OFF
#set_global_assignment -name MUX_RESTRUCTURE OFF
#set_global_assignment -name OPTIMIZE_POWER_DURING_SYNTHESIS "NORMAL COMPILATION"
#set_global_assignment -name STATE_MACHINE_PROCESSING AUTO
#set_global_assignment -name PARALLEL_SYNTHESIS ON
#set_global_assignment -name AUTO_PACKED_REGISTERS_STRATIXII NORMAL
#set_global_assignment -name AUTO_PACKED_REGISTERS_MAXII NORMAL
#set_global_assignment -name AUTO_PACKED_REGISTERS_CYCLONE NORMAL
#set_global_assignment -name AUTO_PACKED_REGISTERS NORMAL
#set_global_assignment -name AUTO_PACKED_REGISTERS_STRATIX NORMAL
#set_global_assignment -name PRE_MAPPING_RESYNTHESIS ON
#set_global_assignment -name SYNTH_PROTECT_SDC_CONSTRAINT ON

#Don't produce too much messages
set_global_assignment -name HDL_MESSAGE_LEVEL LEVEL1
set_global_assignment -name SYNTH_MESSAGE_LEVEL LOW

# Timing report.
#Enable Worst-Case Timing Report
#set_global_assignment -name TIMEQUEST_DO_REPORT_TIMING ON
#set_global_assignment -name TIMEQUEST_REPORT_WORST_CASE_TIMING_PATHS ON
#Report 10 paths per clock domain
#set_global_assignment -name TIMEQUEST_REPORT_NUM_WORST_CASE_TIMING_PATHS 10

# Commit assignments
#export_assignments

execute_module -tool map
execute_module -tool fit
execute_module -tool asm
execute_module -tool sta -args {--report_script @TEST_ROOT@/extract_timing.tcl}

load_report
################################################################################
# Summary
set DataJSON [open "@REPORT_JSON@" a+]
puts $DataJSON "\"Input_Num \":\"@INPUT_NUM@\","
puts $DataJSON "\"Bit_Width \":\"@WIDTH@\","
puts $DataJSON "\"Total_LEs \":\"[get_fitter_resource_usage -le -used]\""
puts $DataJSON "\}"

close $DataJSON
unload_report


project_close
